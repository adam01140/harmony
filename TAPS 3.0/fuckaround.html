<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #title {
            border: 2px solid lightblue;
            width: fit-content;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
        #sightings {
            margin-top: 0px;
            width: 80%;
        }
        #report {
            margin-top: 20px;
            width: 80%;
            text-align: center;
        }
        button {
            margin-top: 20px;
            width: 100%;
            height: 40px;
            font-size: 16px;
        }
        .sighting {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        #map {
            height: 400px;
            width: 80%;
            margin: 20px auto;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD27CKLddswkn-DTg6anVo8BaRWUZJrHao&callback=initMap" async defer></script>
</head>
<body>
    <div id="title">
        <h1><b>TAPS Tracker</b></h1>
    </div>
    <br>
    <h2>Recent Sightings</h2>
    <div id="sightings"></div>
    <div id="map"></div>
    <div id="venmo">
        <center>
            <h2>Fund the project</h2>
            <img src="https://i.ibb.co/t42P1W6/qr-code.png" alt="QR Code" style="width:200px;">
            <p>or</p>
            <p>@Taps-Tracker</p>
        </center>
    </div>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyAgYdoZnSv5ekxngv_ue61aFZUGcRlphok",
            authDomain: "defundtaps.firebaseapp.com",
            projectId: "defundtaps",
            storageBucket: "defundtaps.appspot.com",
            messagingSenderId: "456064481827",
            appId: "1:456064481827:web:4a4b37035fbfbd534ccf96",
            measurementId: "G-4ZX480FN46"
        };
        firebase.initializeApp(firebaseConfig);

        async function init() {
            const userCredential = await firebase.auth().signInAnonymously();
        }
        init();

        var db = firebase.firestore();
        
        let allSightings = [];
        let showingAll = false;
		
		var map;
        var markers = [];
        var colleges = [
			
			{name: "Cowell Lot 106", lat: 36.998280, lng: -122.053877},
			{name: "Cowell Lot 107", lat: 36.997918, lng: -122.053193},
			{name: "Cowell Lot 108", lat: 36.997613, lng: -122.052994},
			{name: "Cowell Circle", lat: 36.997705, lng: -122.053444},
			
			
            {name: "Stevenson Lot 109", lat: 36.998219, lng: -122.052683},
			{name: "Stevenson Lot 110", lat: 36.998220, lng: -122.051618},
			{name: "Stevenson Circle", lat: 36.998220, lng: -122.051618},
			
			{name: "Gym Lot 103", lat: 36.994980, lng: -122.055254},
			{name: "East Remote", lat: 36.991035, lng: -122.053164},
			{name: "West Remote", lat: 36.988550, lng: -122.065901},
			{name: "college 10", lat: 36.985349, lng: -122.055505},
			{name: "Baytree Bookstore Lot 102", lat: 36.997399, lng: -122.055595},
			
			
			{name: "McHenry Library Lot 101", lat: 36.995104, lng: -122.057185},
			{name: "McHenry Library Lot 120", lat: 36.996277, lng: -122.059167},
			
			{name: "Music Building Lot 126", lat: 36.993388, lng: -122.061556},
			
			
            {name: "Merrill Lot 119", lat: 36.999681, lng: -122.051747},
			{name: "Merrill Circle", lat: 6.999544, lng: -122.052738},
			
			
			{name: "Porter Lot 124", lat: 36.994370, lng: -122.064150},
            {name: "Porter Lot 125", lat: 36.993800, lng: -122.064738},
			
			
            {name: "Rachel Carson Lot 146", lat: 36.992282, lng: -122.064506},
			{name: "Rachel Carson Lot 160", lat: 36.990212, lng: -122.064780},
			{name: "Rachel Carson Lot 161", lat: 36.990005, lng: -122.064874},
			{name: "Rachel Carson Lot 162", lat: 36.990049, lng: -122.065698},
			
			{name: "Family Housing Lot 129", lat: 36.991003, lng: -122.067091},
			{name: "Family Housing Lot 130", lat: 36.990828, lng: -122.067578},
			{name: "Family Housing Lot 131", lat: 36.991186, lng: -122.067705},
			{name: "Family Housing Lot 132", lat: 36.990828, lng: -122.068376},
			{name: "Family Housing Lot 133", lat: 36.991198, lng: -122.068438},
			{name: "Family Housing Lot 134", lat: 36.990586, lng: -122.068785},
			{name: "Family Housing Lot 135", lat: 36.991865, lng: -122.067683},
			{name: "Family Housing Lot 136", lat: 36.992580, lng: -122.067582},
			
			
			{name: "Kresge Lot 142", lat: 36.999190, lng: -122.066422},
			{name: "Kresge Lot 143", lat: 36.997061, lng: -122.067064},
			{name: "Kresge Lot 145", lat: 36.997276, lng: -122.067244},
            {name: "Kresge Lot 147", lat: 36.996812, lng: -122.065315},
			
			{name: "West Parking Garage", lat: 36.999068, lng: -122.063678},
			{name: "West Charging Station", lat: 36.999126, lng: -122.063343},
			
			{name: "Jack Baskin Lot 157", lat: 36.999126, lng: -122.063343},
			{name: "Jack Baskin Lot 138", lat: 37.000204, lng: -122.063897},
			
			{name: "Thimann Lot 138", lat: 36.998152, lng: -122.062603},
			
			
			{name: "Redwood Grove Lot 158", lat: 36.998293, lng: -122.064609},
			{name: "Redwood Grove Lot 159", lat: 36.997111, lng: -122.063948},
			
			
            {name: "Oakes Circle", lat: 36.990163, lng: -122.063304},
			
			{name: "College 10 Lot 114", lat: 37.000129, lng: -122.058957},
			{name: "College 10 Lot 164", lat: 37.000826, lng: -122.059137},
			{name: "College 10 Lot 165", lat: 37.001753, lng: -122.059404},
			{name: "College 10 Lot 165", lat: 37.001753, lng: -122.059404},
			{name: "College 10 Lot 167", lat: 37.003277, lng: -122.058957},
			
            {name: "College 9 Lot 166", lat: 37.001763, lng: -122.057817},
			{name: "College 9 Lot 166", lat: 37.001763, lng: -122.057817}

        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 36.9905, lng: -122.0584},
                zoom: 15
            });

            for (let i = 0; i < colleges.length; i++) {
                let college = colleges[i];
                let marker = new google.maps.Marker({
                    position: {lat: college.lat, lng: college.lng},
                    map: map,
                    title: college.name
                });
                marker.addListener('click', function() {
                    reportSighting(college.name);
                });
                markers.push(marker);
            }
        }
		
		
		window.reportSighting = async function() {
            var college = document.getElementById("collegeSelect").value;
            const userId = firebase.auth().currentUser.uid;
            
            const userRef = db.collection('userReports').doc(userId);
            const doc = await userRef.get();

            if (!doc.exists) {
                await userRef.set({count: 1});
            } else if (doc.data().count < 50) {
                await userRef.update({count: firebase.firestore.FieldValue.increment(1)});
            } else {
                alert('You have reported too many times!');
                return;
            }

            try {
                const newSighting = await db.collection('sightings').add({
                    uid: userId,
                    college: college,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                const sightingSnapshot = await newSighting.get();
                allSightings.unshift(sightingSnapshot.data());
                displaySightings();
            } catch (error) {
                alert('Error reporting sighting. Please try again.');
            }
        }

        function displaySightings() {
            const sightingsContainer = document.getElementById("sightings");
            sightingsContainer.innerHTML = "";
            const sightingsToShow = showingAll ? allSightings.slice(0, 10) : allSightings.slice(0, 5);
            sightingsToShow.forEach(sighting => {
                var sightingDiv = document.createElement("div");
                sightingDiv.className = "sighting";
                sightingDiv.innerHTML = "<strong>" + sighting.college + "</strong><br>" + sighting.timestamp.toDate().toLocaleString();
                sightingsContainer.appendChild(sightingDiv);
            });
            if (allSightings.length > 5) {
                var toggleButton = document.createElement("button");
                toggleButton.innerText = showingAll ? "Show Less" : "Show More";
                toggleButton.onclick = function() {
                    showingAll = !showingAll;
                    displaySightings();
                };
                sightingsContainer.appendChild(toggleButton);
            }
        }

        window.onload = async function() {
            const querySnapshot = await db.collection('sightings').orderBy('timestamp', 'desc').get();
            querySnapshot.forEach((doc) => {
                let sighting = doc.data();
                allSightings.push(sighting);
            });
            displaySightings();
        }
    </script>
</body>

</html>